// /workspaces/home-assistant-frontend-types/generate-index-dts.js
const fs = require('fs');
const path = require('path'); // Standard path module
// const path = require('node:path/posix'); // Node.js v16+ specific way for clarity

const typesDir = path.join(__dirname, 'dist');
const outputFile = path.join(typesDir, 'index.d.ts');
const reExports = [];

// Recursively walks through the 'dist' directory to find all .d.ts files
// and generates 'export * from' statements using POSIX (forward) slashes.
function generateReExports(currentDir, relativePathBase = '') {
  const items = fs.readdirSync(currentDir);

  for (const item of items) {
    const fullPath = path.join(currentDir, item);
    // Use path.posix.join for the relative path that will go into the import statement
    const relativeItemPath = path.posix.join(relativePathBase, item);
    const stats = fs.statSync(fullPath);

    if (stats.isDirectory()) {
      generateReExports(fullPath, relativeItemPath);
    } else if (item.endsWith('.d.ts') && item !== 'index.d.ts') {
      const importPath = relativeItemPath.slice(0, -5); // Remove .d.ts extension
      // Ensure the path uses forward slashes. path.posix.join already handles this.
      reExports.push(`export * from './${importPath}';`);
    }
  }
}

// Ensure dist directory exists
if (!fs.existsSync(typesDir)){
  fs.mkdirSync(typesDir, { recursive: true });
}

// Clear previous index.d.ts to ensure a clean build
if (fs.existsSync(outputFile)) {
  fs.unlinkSync(outputFile);
}

generateReExports(typesDir); // Start walking from the 'dist' directory

// Add a header to the generated file for clarity and warnings
const header = `// This file is auto-generated by a script. Do not modify manually.
// It re-exports types from the sub-modules of the home-assistant-frontend-types package.
//
// IMPORTANT: Due to the large and nested nature of Home Assistant Frontend,
// there is a risk of name clashes if multiple modules export types with the same name.
// If you encounter TypeScript errors related to duplicate identifiers or ambiguous imports,
// you might need to:
//   1. Adjust this script to selectively re-export.
//   2. Fall back to importing specific types by their full sub-path:
//      e.g., import { SpecificType } from 'home-assistant-frontend-types/data/hass';
//
`;
fs.writeFileSync(outputFile, header + reExports.join('\n'));

console.log(`Generated ${outputFile} with ${reExports.length} re-exports.`);